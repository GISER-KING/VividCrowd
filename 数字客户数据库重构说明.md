# 数字客户数据库重构说明

## 变更概述

本次重构解决了以下问题：
1. **移除级联删除** - 不再使用 CASCADE 删除，改用冗余字段存储关键信息
2. **避免重复导入** - 添加文件注册表，通过文件哈希值检测重复
3. **启动自动导入** - 应用启动时自动扫描并导入 `data/customer_profiles/` 目录中的文件

---

## 数据库结构变更

### 1. 新增表：CustomerProfileRegistry（客户画像文件注册表）

```sql
CREATE TABLE customer_profile_registry (
    id INTEGER PRIMARY KEY,
    filename VARCHAR(255) UNIQUE NOT NULL,      -- 文件名
    file_hash VARCHAR(64) NOT NULL,             -- MD5 哈希值
    customer_profile_id INTEGER,                -- 关联的客户画像ID
    customer_name VARCHAR(100),                 -- 客户姓名（冗余）
    customer_profile_type VARCHAR(100),         -- 客户画像类型（冗余）
    status VARCHAR(20) DEFAULT 'success',       -- 导入状态
    imported_at DATETIME                        -- 导入时间
);
```

**作用：**
- 记录所有已导入的文件
- 通过文件哈希值避免重复导入
- 即使文件名不同，只要内容相同就会被识别为重复

### 2. CustomerChunk 表变更

**新增字段：**
- `customer_name` - 客户姓名（冗余）
- `customer_profile_type` - 客户画像类型（冗余）

**移除：**
- 外键的 `ON DELETE CASCADE` 约束

**好处：**
- 删除客户时不会自动删除 chunk，保留历史数据
- 可以通过冗余字段查看 chunk 属于哪个客户

### 3. TrainingSession 表变更

**新增字段：**
- `customer_name` - 客户姓名（冗余）
- `customer_profile_type` - 客户画像类型（冗余）
- `customer_occupation` - 职业（冗余）
- `customer_industry` - 行业（冗余）
- `total_rounds` - 总轮次
- `created_at` - 创建时间
- `updated_at` - 更新时间

**移除：**
- 外键的 `ON DELETE CASCADE` 约束

**好处：**
- 删除客户后，培训记录仍然保留
- 可以查看历史培训记录中的客户信息

### 4. 其他表变更

- `ConversationRound` - 移除 CASCADE
- `StageEvaluation` - 移除 CASCADE
- `FinalEvaluation` - 移除 CASCADE

---

## 新功能：自动导入

### 工作原理

1. **启动扫描** - 应用启动时自动扫描 `data/customer_profiles/` 目录
2. **文件检测** - 支持 `.pdf` 和 `.md` 文件
3. **哈希校验** - 计算文件 MD5 哈希值，避免重复导入
4. **自动解析** - 使用 LLM 自动提取客户信息
5. **注册记录** - 导入成功后添加注册记录

### 使用方法

**方式 1：启动时自动导入**

1. 将客户画像文件（PDF 或 Markdown）放入 `data/customer_profiles/` 目录
2. 启动应用，系统会自动导入新文件

```bash
# 创建目录（如果不存在）
mkdir -p data/customer_profiles

# 复制文件到目录
cp 企业决策者.pdf data/customer_profiles/
cp 年轻创业者.md data/customer_profiles/

# 启动应用
python main.py
```

**方式 2：前端上传**

通过前端界面上传文件，系统会自动检查是否重复。

---

## 迁移步骤

### 1. 备份数据库（重要！）

```bash
# 备份现有数据库
cp backend/data/digital_customer.db backend/data/digital_customer.db.backup
```

### 2. 运行迁移脚本

```bash
python backend/migrations/restructure_digital_customer_db.py
```

**迁移脚本会：**
- ✅ 创建 CustomerProfileRegistry 表
- ✅ 重建 CustomerChunk 表并填充冗余字段
- ✅ 重建 TrainingSession 表并填充冗余字段
- ✅ 移除所有 CASCADE 删除约束
- ✅ 保留所有现有数据

### 3. 验证迁移结果

```bash
# 检查表结构
sqlite3 backend/data/digital_customer.db ".schema customer_profile_registry"
sqlite3 backend/data/digital_customer.db ".schema customer_chunks"
sqlite3 backend/data/digital_customer.db ".schema training_sessions"

# 检查数据完整性
sqlite3 backend/data/digital_customer.db "SELECT COUNT(*) FROM customer_profiles"
sqlite3 backend/data/digital_customer.db "SELECT COUNT(*) FROM customer_chunks"
sqlite3 backend/data/digital_customer.db "SELECT COUNT(*) FROM training_sessions"
```

---

## 删除客户的新行为

### 之前（使用 CASCADE）
- 删除客户 → 自动删除所有关联的 chunks、培训记录、评价等
- 数据完全丢失，无法恢复

### 现在（使用冗余字段）
- 删除客户 → 只删除 `customer_profiles` 表中的记录
- chunks、培训记录等保留，通过冗余字段仍可查看历史信息
- 外键 `customer_profile_id` 仍然存在，但不会触发级联删除

**注意：** 如果需要完全删除客户及其所有数据，需要手动删除关联记录：

```python
# 示例：完全删除客户
async def delete_customer_completely(customer_id: int):
    async with digital_customer_async_session() as session:
        # 1. 删除 chunks
        await session.execute(
            delete(CustomerChunk).where(CustomerChunk.customer_profile_id == customer_id)
        )
        # 2. 删除培训记录（需要先删除关联的评价和轮次）
        # ...
        # 3. 最后删除客户
        await session.execute(
            delete(CustomerProfile).where(CustomerProfile.id == customer_id)
        )
        await session.commit()
```

---

## 目录结构

```
data/
├── customer_profiles/          # 自动导入目录（新增）
│   ├── 企业决策者.pdf
│   ├── 年轻创业者.md
│   └── ...
└── digital_customer.db         # 数据库文件

backend/
├── apps/
│   └── digital_customer/
│       └── services/
│           └── auto_import_service.py  # 自动导入服务（新增）
├── migrations/
│   └── restructure_digital_customer_db.py  # 迁移脚本（新增）
└── models/
    └── db_models.py            # 数据库模型（已更新）
```

---

## 常见问题

### Q1: 如果我上传了相同的文件会怎样？
**A:** 系统会计算文件的 MD5 哈希值，如果文件内容相同（即使文件名不同），会直接返回已有的客户画像，不会重复导入。

### Q2: 删除客户后，培训记录还能查看吗？
**A:** 可以。培训记录中保存了客户的冗余信息（姓名、画像类型、职业、行业），即使客户被删除，这些信息仍然可见。

### Q3: 如何清理旧的 chunk 和培训记录？
**A:** 目前需要手动清理。可以编写定时任务，定期删除超过一定时间的孤立记录（customer_profile_id 对应的客户已不存在）。

### Q4: 自动导入失败了怎么办？
**A:** 检查日志输出，常见原因：
- 文件格式不支持（只支持 PDF 和 Markdown）
- LLM 无法提取客户画像类型
- 文件内容格式不规范

### Q5: 迁移脚本可以重复运行吗？
**A:** 可以，但建议只运行一次。重复运行会重新创建表，但不会丢失数据。

---

## 后续优化建议

1. **定时清理任务** - 定期清理孤立的 chunk 和培训记录
2. **批量导入接口** - 支持一次上传多个文件
3. **导入进度显示** - 前端显示自动导入的进度和结果
4. **文件管理界面** - 查看已导入的文件列表，支持重新导入或删除
5. **软删除** - 为 CustomerProfile 添加 `is_deleted` 字段，实现软删除

---

## 技术细节

### 文件哈希计算
```python
import hashlib

def calculate_file_hash(file_path: str) -> str:
    with open(file_path, "rb") as f:
        return hashlib.md5(f.read()).hexdigest()
```

### 重复检测逻辑
```python
# 1. 计算文件哈希
file_hash = calculate_file_hash(file_path)

# 2. 查询注册表
registry = await session.execute(
    select(CustomerProfileRegistry).where(
        CustomerProfileRegistry.file_hash == file_hash
    )
)

# 3. 如果已存在且有关联的客户ID，返回已有客户
if registry and registry.customer_profile_id:
    return existing_customer
```

### 冗余字段填充
```python
# 创建 chunk 时填充冗余字段
customer_chunk = CustomerChunk(
    customer_profile_id=customer.id,
    customer_name=customer.name,              # 冗余
    customer_profile_type=customer.profile_type,  # 冗余
    chunk_text=chunk["text"],
    # ...
)
```

---

## 总结

本次重构实现了：
✅ 移除级联删除，保留历史数据
✅ 文件注册表，避免重复导入
✅ 启动自动导入，简化操作流程
✅ 冗余字段，确保数据可追溯

**下一步：** 运行迁移脚本，测试新功能！
